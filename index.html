<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>åˆå¤œè¿½æ“Šè€…ãƒ»ä¹å®®æ ¼è¨˜æ†¶å·¥å…·ï¼ˆWebï¼‰</title>
  <style>
    :root{
      --bg:#0f1115; --fg:#e6e6e6; --muted:#9aa4b2; --card:#13161c; --card-border:#242a36; --well:#0c0f14;
    }
    :root[data-theme="light"]{
      --bg:#f6f7fb; --fg:#0e1116; --muted:#596273; --card:#ffffff; --card-border:#dfe5ee; --well:#f1f4f9;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", Arial}
    header{padding:20px;border-bottom:1px solid var(--card-border);position:sticky;top:0;background:color-mix(in oklab, var(--bg) 90%, transparent);backdrop-filter:blur(8px);display:flex;align-items:center;gap:12px}
    h1{margin:0;font-size:18px;letter-spacing:.5px}
    .spacer{flex:1}
    button, select{background:var(--card);color:var(--fg);border:1px solid var(--card-border);border-radius:10px;padding:8px 12px;font-size:14px}
    button{cursor:pointer}
    button:hover{filter:brightness(1.05)}

    main{padding:20px;display:grid;place-items:center}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(3, 220px);grid-auto-rows:220px}
    .cell{background:var(--card);border:1px solid var(--card-border);border-radius:14px;padding:10px;display:flex;flex-direction:column}
    .title{font-size:13px;color:var(--muted);margin-bottom:6px}
    .imgbox{flex:1;display:grid;place-items:center;background:var(--well);border-radius:10px;overflow:hidden;border:1px dashed var(--card-border)}
    .imgbox img{max-width:100%;max-height:100%;object-fit:contain;image-rendering:auto}
    .picker{margin-top:8px}

    /* è§’è½ä¸»é¡Œåˆ‡æ› */
    .theme-toggle{position:fixed;right:16px;bottom:16px;border-radius:999px;padding:10px 12px;display:flex;align-items:center;gap:8px}
    .theme-toggle .icon{font-size:16px}
  </style>
</head>
<body>
  <header>
    <h1>åˆå¤œè¿½æ“Šè€…ãƒ»ä¹å®®æ ¼è¨˜æ†¶å·¥å…·ï¼ˆWebï¼‰</h1>
    <div class="spacer"></div>
    <button id="clear">æ¸…ç©ºæ¬„ä½</button>
  </header>

  <main>
    <div class="grid" id="grid" aria-live="polite"></div>
  </main>

  <button id="themeToggle" class="theme-toggle" title="åˆ‡æ›æ·±/æ·ºè‰²ä¸»é¡Œ">
    <span class="icon" id="themeIcon">ğŸŒ™</span>
    <span id="themeText">æ·±è‰²</span>
  </button>

  <script>
    // ===== ç›¸å®¹æ€§èˆ‡æœ¬æ©Ÿé‹è¡Œå„ªå…ˆ =====
    // ç‚ºäº†é¿å…åœ¨ file:// ä¸‹ fetch è¢«æ“‹ï¼Œé è¨­ç›´æ¥ä½¿ç”¨å…§å»ºé¸é …ã€‚
    // è‹¥åœ¨ http/https ç’°å¢ƒï¼Œæ‰å˜—è©¦è®€ options.jsonï¼ˆè®€ä¸åˆ°å°±ç”¨å…§å»ºï¼‰ã€‚
    // å…§å»ºé¸é …ï¼ˆä½ æä¾›çš„ä¸­æ–‡åç¨±èˆ‡æª”åï¼‰
    
    var OPTIONS_FALLBACK = [
      {"id":1, "name":"ç®±å­",   "image":"images/ç®±å­.png"},
      {"id":2, "name":"æ²™ç™¼",   "image":"images/æ²™ç™¼.png"},
      {"id":3, "name":"æ™‚é˜",   "image":"images/æ™‚é˜.png"},
      {"id":4, "name":"æ’­æ”¾æ©Ÿ", "image":"images/æ’­æ”¾æ©Ÿ.png"},
      {"id":5, "name":"é¡å­",   "image":"images/é¡å­.png"},
      {"id":6, "name":"æ«ƒå­",   "image":"images/æ«ƒå­.png"},
      {"id":7, "name":"é‹¼ç´",   "image":"images/é‹¼ç´.png"},
      {"id":8, "name":"è™Ÿè§’æ‰‹", "image":"images/è™Ÿè§’æ‰‹.png"},
      {"id":9, "name":"åºŠ",     "image":"images/åºŠ.png"}
    ];

    var themeKey = 'mc_theme';
    function applyTheme(t){
      document.documentElement.setAttribute('data-theme', t==='light' ? 'light' : 'dark');
      var icon = document.getElementById('themeIcon');
      var text = document.getElementById('themeText');
      if(icon) icon.textContent = t==='light' ? 'â˜€ï¸' : 'ğŸŒ™';
      if(text) text.textContent = t==='light' ? 'æ·ºè‰²' : 'æ·±è‰²';
      try { localStorage.setItem(themeKey, t); } catch(e) {}
    }
    var savedTheme = null;
    try { savedTheme = localStorage.getItem(themeKey); } catch(e) { savedTheme = null; }
    applyTheme(savedTheme || 'dark');
    var themeBtn = document.getElementById('themeToggle');
    if(themeBtn){
      themeBtn.addEventListener('click', function(){
        var cur = document.documentElement.getAttribute('data-theme')==='light' ? 'light' : 'dark';
        applyTheme(cur==='light' ? 'dark' : 'light');
      });
    }

    var POSITIONS = [
      ['å·¦ä¸Š','ä¸­ä¸Š','å³ä¸Š'],
      ['å·¦ä¸­','ä¸­','å³ä¸­'],
      ['å·¦ä¸‹','ä¸­ä¸‹','å³ä¸‹']
    ];

    function htmlEscape(str){ return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

    function optionSelectHTML(options){
      var out = '<option value=""></option>';
      for(var i=0;i<options.length;i++){
        var n = options[i].name;
        out += '<option value="' + htmlEscape(n) + '">' + htmlEscape(n) + '</option>';
      }
      return out;
    }

    var gridKey = 'mc_grid';
    function loadGrid(){
      try { return JSON.parse(localStorage.getItem(gridKey)||'null') || new Array(9).fill(''); }
      catch(e){ return new Array(9).fill(''); }
    }
    function saveGrid(names){ try { localStorage.setItem(gridKey, JSON.stringify(names)); } catch(e){} }
    function clearGrid(){ try { localStorage.removeItem(gridKey); } catch(e){} }

    function setCellImage(imgEl, name, options){
      var found = null;
      for(var i=0;i<options.length;i++){ if(options[i].name===name){ found = options[i]; break; } }
      if(!found || !found.image){ imgEl.src=''; imgEl.style.display='none'; return; }
      imgEl.src = found.image; imgEl.style.display='block';
    }

    function renderWithOptions(options){
      var grid = document.getElementById('grid');
      if(!grid) return;
      var saved = loadGrid();
      grid.innerHTML='';
      var idx=0;
      for(var r=0;r<3;r++){
        for(var c=0;c<3;c++){
          var wrap = document.createElement('div');
          wrap.className='cell';
          var title = document.createElement('div');
          title.className='title';
          title.textContent = POSITIONS[r][c];

          var imgbox = document.createElement('div');
          imgbox.className='imgbox';
          var img = document.createElement('img');
          img.alt='';
          imgbox.appendChild(img);

          var picker = document.createElement('div');
          picker.className='picker';
          picker.innerHTML = '<select>' + optionSelectHTML(options) + '</select>';
          var sel = picker.querySelector('select');
          sel.addEventListener('change', function(selRef, imgRef){
            return function(){
              setCellImage(imgRef, selRef.value, options);
              var names = Array.prototype.map.call(document.querySelectorAll('.cell select'), function(s){ return s.value||''; });
              saveGrid(names);
            }
          }(sel, img));

          if(saved[idx]) sel.value = saved[idx];
          setCellImage(img, sel.value, options);

          wrap.appendChild(title);
          wrap.appendChild(imgbox);
          wrap.appendChild(picker);
          grid.appendChild(wrap);
          idx++;
        }
      }
    }

    function init(){
      if(location.protocol==='http:' || location.protocol==='https:'){
        // å˜—è©¦å¾åŒè³‡æ–™å¤¾è®€ options.json
        fetch('options.json', {cache:'no-cache'})
          .then(function(res){ if(!res.ok) throw new Error('read options.json failed'); return res.json(); })
          .then(function(data){ if(!Array.isArray(data) || data.length!==9) throw new Error('bad options.json'); renderWithOptions(data); })
          .catch(function(){ renderWithOptions(OPTIONS_FALLBACK); });
      } else {
        //å…§å»º
        renderWithOptions(OPTIONS_FALLBACK);
      }
    }

    var clearBtn = document.getElementById('clear');
    if(clearBtn){
      clearBtn.addEventListener('click', function(){
        var selects = document.querySelectorAll('.cell select');
        for(var i=0;i<selects.length;i++){ selects[i].value=''; }
        var imgs = document.querySelectorAll('.cell img');
        for(var j=0;j<imgs.length;j++){ imgs[j].src=''; imgs[j].style.display='none'; }
        clearGrid();
      });
    }

    // å•Ÿå‹•
    init();
  </script>
</body>
</html>
